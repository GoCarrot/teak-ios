machine:
  xcode:
    version: 9.0
checkout:
  post:
    - git fetch --tags
deployment:
  prod:
    branch: master
    commands:
      - aws s3 cp build/Release-iphoneos/Teak.framework.zip s3://teak-build-artifacts/ios/Teak-$(git describe --tags --always).framework.zip --acl public-read
      - aws s3 cp build/Release-iphoneos/Teak.framework.zip s3://teak-build-artifacts/ios/Teak.framework.zip --acl public-read
compile:
  override:
  - ./validate-code-format
  - ./compile
dependencies:
  pre:
  - brew update # Fixes: Homebrew must be run under Ruby 2.3!
  - ./setup
  cache_directories:
    - ~/Library/Caches/Homebrew/
test:
  override:
    - ./framework-sanity
    - set -o pipefail &&
      xcodebuild
        CODE_SIGNING_REQUIRED=NO
        CODE_SIGN_IDENTITY=
        PROVISIONING_PROFILE=
        -project Automated/Automated.xcodeproj
        -sdk iphonesimulator
        -destination 'platform=iOS Simulator,OS=11.0.1,name=iPhone 8'
        -scheme Automated
        clean build test |
      tee $CIRCLE_ARTIFACTS/xcode_raw.log |
      xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results.xml
