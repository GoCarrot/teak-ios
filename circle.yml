machine:
  xcode:
    version: 8.3
checkout:
  post:
    - git fetch --tags
deployment:
  prod:
    branch: master
    commands:
      - aws s3 cp build/Release-iphoneos/Teak.framework.zip s3://teak-build-artifacts/ios/Teak-$(git describe --tags --always).framework.zip --acl public-read
      - aws s3 cp build/Release-iphoneos/TeakResources.bundle.zip s3://teak-build-artifacts/ios/TeakResources-$(git describe --tags --always).bundle.zip --acl public-read
      - aws s3 cp build/Release-iphoneos/Teak.framework.zip s3://teak-build-artifacts/ios/Teak.framework.zip --acl public-read
      - aws s3 cp build/Release-iphoneos/TeakResources.bundle.zip s3://teak-build-artifacts/ios/TeakResources.bundle.zip --acl public-read
      - aws s3 cp TeakExtensions/TeakNotificationContent/Info.plist s3://teak-build-artifacts/ios/Info-$(git describe --tags --always).plist --acl public-read
      - aws s3 cp TeakExtensions/TeakNotificationContent/Info.plist s3://teak-build-artifacts/ios/Info.plist --acl public-read
compile:
  override:
  - ./validate-code-format
  - ./import_notification_categories notification_categories.csv
  - ./compile
dependencies:
  pre:
  - brew update # Fixes: Homebrew must be run under Ruby 2.3!
  - ./setup
  cache_directories:
    - ~/Library/Caches/Homebrew/
test:
  #override:
  disabled:
    - ./framework-sanity
    - set -o pipefail &&
      xcodebuild
        CODE_SIGNING_REQUIRED=NO
        CODE_SIGN_IDENTITY=
        PROVISIONING_PROFILE=
        -project Automated/Automated.xcodeproj
        -scheme Automated
        -sdk iphonesimulator
        -destination 'platform=iOS Simulator,OS=11.2,name=iPhone X'
        clean build test |
      tee $CIRCLE_ARTIFACTS/xcode_raw.log |
      xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results.xml
